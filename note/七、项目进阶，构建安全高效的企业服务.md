## 项目进阶、构建安全高效的企业服务

#### 一：Spring Security

- 简介
  - Spring Security 是一个专注为 Java 应用程序提供身份认证和授权的框架，它的强大之处在于它可以轻松扩展以满足自定义的需求。
- 特征
  - 对身份的<strong style="color: red">认证</strong>和<strong style="color: red">授权</strong>提供全面的，可扩展的支持
  - 防止各种攻击，如会话固定攻击，点击劫持，csrf攻击等
  - 支持与 Servlet API，Spring MVC 等 Web 技术集成
- 官网地址
  - http://spring.io/projects/spring-security

- Spring Security 原理示意图

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gruvs7gw6ij31ql0u0do2.jpg" alt="image-20210625222746721" style="zoom:50%;" align="left"/>



#### 二：权限控制

- 登陆检查

  - 之前采用拦截器登陆实现了登陆检查，这是简单的权限管理方案，现在将其废弃

- 授权配置

  - 对当前系统内包含的所有的请求，分配访问权限（普通用户，版主，管理员）

- 认证方案

  - 绕过 Security 认证流程，采用系统原来的认证方案

- CSRF 配置

  - CSRF  是什么？

    CSRF 即：cross-site-request-forgery（ 跨站请求伪造）

    - 浏览并登陆信任网站 A
    - 验证通过，在 Client 处产生 A 的 Cookie
    - 用户在没有登出 A 网站的情况下，访问危险⚠️网站 B
    - B 盗取 A 的 Cookie 信息
    - B 带着盗取的 Cookie 伪造用户身份向 A 网站发出请求，伪造身份登陆

    <img src="https://tva1.sinaimg.cn/large/008i3skNgy1grw25imb4kj30xk0u00wx.jpg" alt="image-20210626225342665" style="zoom:50%;" align="left"/>

  - Security 防止 CSRF 攻击的基本原理，以及表单，AJAX 相关的配置

    - Spring Security 防止 CSRF 攻击的原理就是会根据，访问的 request 是否携带 token

    <img src="https://tva1.sinaimg.cn/large/008i3skNgy1grw2iaggp2j30w20u0gre.jpg" alt="image-20210626230610378" style="zoom:50%;" align="left"/>


#### 三：置顶，加精，删除

- 功能实现
  - 点击 “置顶”，修改帖子的类型
  - 点击 “加精”，“删除” 修改帖子的状态
- 权限管理
  - 版主可以执行 “置顶”，“加精” 操作
  - 管理员可以执行 “删除”。操作。
- 按钮显示
  - 版主可以看到 “置顶”，“加精” 按钮
  - 管理员可以看到 “删除” 按钮

需要用到的包

```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
</dependency>
```



在业务逻辑上：

我们需要增加两个方法，修改帖子状态以及修改帖子类型

```java
public int updateDiscussPostType(int id, int type) {
    return discussPostDao.updateDiscussPostType(id, type);
}

public int updateDiscussPostStatus(int id, int status) {
    return discussPostDao.updateDiscussPostStatus(id, status);
}
```

处理异步请求：

```java
		// 置顶
    // 异步请求
    // type : 0 为普通帖子，1 为置顶帖子
    @PostMapping("/top")
    @ResponseBody
    public String setTopType(int id) {
        discussPostService.updateDiscussPostType(id, DISCUSS_TYPE_TOP);
        // 触发更新帖子事件
        Event event = new Event()
                .setTopic(TOPIC_PUBLISH)
                .setUserId(hostHolder.getUser().getId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(id);
        producer.fireEvent(event);
        return MyUtil.getJSONString(0);
    }

    // 加精
    // 异步请求
    // status : 0 为普通，1 为加精，2 为拉黑（删除）
    @PostMapping("/wonderful")
    @ResponseBody
    public String setWonderfulStatus(int id) {
        discussPostService.updateDiscussPostStatus(id, DISCUSS_STATUS_WONDERFUL);
        Event event = new Event()
                .setTopic(TOPIC_PUBLISH)
                .setUserId(hostHolder.getUser().getId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(id);
        producer.fireEvent(event);
        return MyUtil.getJSONString(0);
    }

    // 删除
    // 异步请求
    @PostMapping("/delete")
    @ResponseBody
    public String setDeleteStatus(int id) {
        discussPostService.updateDiscussPostStatus(id, DISCUSS_STATUS_DELETE);
        // 触发删帖事件
        Event event = new Event()
                .setTopic(TOPIC_DELETE)
                .setUserId(hostHolder.getUser().getId())
                .setEntityType(ENTITY_TYPE_POST)
                .setEntityId(id);
        producer.fireEvent(event);
        return MyUtil.getJSONString(0);
    }
```

我们需要在消息队列中做出同步，让 elasticsearch 能够消费事件，在搜索引擎中同步帖子的状态:

```java
		// 发帖,更新帖子事件
    @KafkaListener(topics = {TOPIC_PUBLISH})
    public void handlePublishMessage(ConsumerRecord record) {
        if (record == null || record.value() == null) {
            logger.error("消息内容为空");
            return;
        }
        Event event = JSONObject.parseObject(record.value().toString(), Event.class);
        if (event == null) {
            logger.error("消息格式错误");
            return;
        }
        DiscussPost post = discussPostService.getDiscussPostById(event.getEntityId());
        elasticsearchService.saveDiscussPost(post);
    }

    // 删帖事件
    @KafkaListener(topics = {TOPIC_DELETE})
    public void handleDeleteMessage(ConsumerRecord record) {
        if (record == null || record.value() == null) {
            logger.error("消息内容为空");
            return;
        }
        Event event = JSONObject.parseObject(record.value().toString(), Event.class);
        if (event == null) {
            logger.error("消息格式错误");
            return;
        }
        elasticsearchService.deleteDiscussPost(event.getEntityId());
    }
```



在 SpringSecurityConifg 中做出授权管理：

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    // 授权
    http.authorizeRequests()
            .antMatchers(
                    "/discuss/top",
                    "/discuss/wonderful"
            )
            .hasAnyAuthority(AUTHORITY_MODERATOR)
            .antMatchers(
                    "/discuss/delete"
            ).hasAnyAuthority(AUTHORITY_ADMIN)
            .anyRequest().permitAll()
            .and().csrf().disable();
```



页面上的处理，版主可以看到置顶，加精两个按钮，管理员可以看到删除按钮

引入包：

```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
</dependency>
```

页面上的处理；

```html
<input type="hidden" id="postId" th:value="${post.id}">
<button type="button" 
        class="btn btn-danger btn-sm"
        id="topBtn"
        th:disabled="${post.type==1}" sec:authorize="hasAnyAuthority('moderator')">
    置顶
</button>
<button type="button" 
        class="btn btn-danger btn-sm" id="wonderfulBtn"
        th:disabled="${post.status==1}" 
        sec:authorize="hasAnyAuthority('moderator')">
    加精
</button>
<button type="button" 
        class="btn btn-danger btn-sm" 
        id="deleteBtn"
        th:disabled="${post.status==2}" 
        sec:authorize="hasAnyAuthority('admin')">
    删除
</button>
```

效果示意图：

未登陆的用户无任何权限

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1grwouaeb23j315a0u0jvu.jpg" alt="image-20210627115851986" style="zoom:50%;" align="left"/>

普通用户：

账号名 ：aaa

密码：aaa

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1grwovw0hrmj314x0u0wix.jpg" alt="image-20210627120022714" style="zoom:50%;" align="left"/>

版主：

用户名：nowcoder21

密码：123456

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1grwoyz3y19j314y0u0tct.jpg" alt="image-20210627120213254" style="zoom:50%;" align="left"/>

管理员：

用户名：nowcoder11

密码：123456

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1grwp18pkahj315n0u042a.jpg" alt="image-20210627120527193" style="zoom:50%;" align="left"/>

#### 四：